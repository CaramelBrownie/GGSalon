<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f9; color:#333; }
    header { background:#222; color:#fff; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:1.5rem; }
    .logout-btn { background:#e74c3c; border:none; padding:0.5rem 1rem; color:#fff; border-radius:6px; cursor:pointer; }
    main { max-width:1200px; margin:2rem auto; padding:1rem; }
    section { margin-bottom:2rem; background:#fff; padding:1rem; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h2 { margin-top:0; border-bottom:1px solid #ddd; padding-bottom:0.5rem; margin-bottom:1rem; }
    table { width:100%; border-collapse:collapse; margin-bottom:1rem; }
    th, td { border:1px solid #ddd; padding:0.5rem; text-align:left; }
    th { background:#f9f9f9; }
    .btn { padding:0.4rem 0.8rem; border:none; border-radius:4px; cursor:pointer; margin-right:0.3rem; font-size:0.85rem; }
    .btn-approve { background:#27ae60; color:#fff; }
    .btn-complete { background:#2980b9; color:#fff; }
    .btn-cancel { background:#e74c3c; color:#fff; }
    .btn-delete { background:#7f8c8d; color:#fff; }
    .empty { text-align:center; font-style:italic; color:#666; padding:1rem; }
  </style>
</head>
<body>

<header>
  <h1>Manager Dashboard</h1>
  <button class="logout-btn" id="logoutBtn">Logout</button>
</header>

<main id="dashboardMain">
  <!-- Staff Overview -->
  <section>
    <h2>Staff Overview</h2>
    <table id="staffTable">
      <thead>
        <tr>
          <th>Staff ID</th>
          <th>Name</th>
          <th>Role</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="staffEmpty" class="empty hidden">No staff registered yet.</p>
  </section>

  <!-- Appointments Overview -->
  <section>
    <h2>Appointments Overview</h2>
    <table id="apptTable">
      <thead>
        <tr>
          <th>Client</th>
          <th>Services</th>
          <th>Date & Time</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="apptEmpty" class="empty hidden">No appointments booked yet.</p>
  </section>
</main>

<script>
  // --- Elements ---
  const staffTableBody = document.querySelector("#staffTable tbody");
  const staffEmpty = document.getElementById("staffEmpty");
  const apptTableBody = document.querySelector("#apptTable tbody");
  const apptEmpty = document.getElementById("apptEmpty");
  const logoutBtn = document.getElementById("logoutBtn");

  // --- Auth check ---
  const currentUser = JSON.parse(localStorage.getItem("gg_staff_logged_in"));
  if(!currentUser || currentUser.role !== "manager"){
    document.getElementById("dashboardMain").innerHTML = "<p style='text-align:center; padding:2rem;'>You do not have permission to view this page.</p>";
  }

  // --- Logout ---
  logoutBtn.addEventListener("click", ()=> {
    localStorage.removeItem("gg_staff_logged_in");
    window.location.href = "login.html";
  });

  // --- Load data ---
  function loadStaff(){ return JSON.parse(localStorage.getItem("staffAccounts")) || []; }
  function loadAppointments(){ 
    const allAppts = JSON.parse(localStorage.getItem("confirmedAppointments")) || {};
    return Object.values(allAppts).flat(); 
  }

  // --- Render Staff ---
  function renderStaff(){
    const staffList = loadStaff();
    staffTableBody.innerHTML = "";
    if(staffList.length === 0){ staffEmpty.classList.remove("hidden"); return; }
    staffEmpty.classList.add("hidden");
    staffList.forEach(s=>{
      const row = document.createElement("tr");
      row.innerHTML = `<td>${s.staffId}</td><td>${s.name}</td><td>${s.role}</td>`;
      staffTableBody.appendChild(row);
    });
  }

  // --- Render Appointments ---
  function renderAppointments(){
    const appts = loadAppointments();
    apptTableBody.innerHTML = "";
    if(appts.length === 0){ apptEmpty.classList.remove("hidden"); return; }
    apptEmpty.classList.add("hidden");
    appts.forEach((a,i)=>{
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${a.client?.fullname || '—'}</td>
        <td>${a.itemNames?.join(", ") || '—'}</td>
        <td>${a.date} • ${a.time}</td>
        <td>${a.status || 'pending'}</td>
        <td>
          ${a.status !== 'pending' ? '' : `<button class="btn btn-approve" onclick="updateStatus(${i},'pending')">Approve</button>`}
          ${a.status !== 'completed' ? `<button class="btn btn-complete" onclick="updateStatus(${i},'completed')">Complete</button>` : ''}
          ${a.status !== 'canceled' ? `<button class="btn btn-cancel" onclick="updateStatus(${i},'canceled')">Cancel</button>` : ''}
          <button class="btn btn-delete" onclick="deleteAppt(${i})">Delete</button>
        </td>
      `;
      apptTableBody.appendChild(row);
    });
  }

  // --- Update Appointment Status ---
  window.updateStatus = function(index,newStatus){
    const allAppts = JSON.parse(localStorage.getItem("confirmedAppointments")) || {};
    const flatList = Object.values(allAppts).flat();
    if(index < 0 || index >= flatList.length) return;

    flatList[index].status = newStatus;

    // Reconstruct nested structure
    const grouped = {};
    flatList.forEach(a=>{
      const id = a.clientId || 'guest';
      grouped[id] = grouped[id] || [];
      grouped[id].push(a);
    });
    localStorage.setItem("confirmedAppointments", JSON.stringify(grouped));
    renderAppointments();
  }

  // --- Delete Appointment ---
  window.deleteAppt = function(index){
    if(!confirm("Are you sure you want to delete this appointment?")) return;
    const allAppts = JSON.parse(localStorage.getItem("confirmedAppointments")) || {};
    let flatList = Object.values(allAppts).flat();
    flatList.splice(index,1);
    const grouped = {};
    flatList.forEach(a=>{
      const id = a.clientId || 'guest';
      grouped[id] = grouped[id] || [];
      grouped[id].push(a);
    });
    localStorage.setItem("confirmedAppointments", JSON.stringify(grouped));
    renderAppointments();
  }

  // --- Initial render ---
  renderStaff();
  renderAppointments();
</script>
</body>
</html>